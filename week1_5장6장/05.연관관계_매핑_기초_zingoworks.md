# 5장 : 연관관계 매핑 기초
1. 단방향 연관관계
2. 연관관계 사용
3. 양방향 연관관계
4. 연관관계의 주인
5. 양방향 연관관계 저장
6. 양방향 연관관계의 주의점
7. 정리
실전예제 : 2. 연관관계 매핑 시작

---

## 목표 : 객체의 참조와 테이블의 외래 키를 매핑
1. 방향
2. 다중성
3. 연관관계의 주인

---

### 단방향 연관관계
* 객체 연관관계
* 테이블 연관관계
* 객체 연관관계와 테이블 연관관계의 가장 큰 **차이**
    * 참조를 통한 연관관계는 언제나 단방향
    * 객체간에 연관관계를 양방향으로 만들고 싶으면 반대쪽에도 필드를 추가해서 참조를 보관해야 한다
    * 하지만 엄밀히 말하면 서로 다른 단방향 관계 2개
* 객체 연관관계 vs 테이블 연관관계 정리
    * 객체는 참조(주소)로 연관관계를 맺는다 -> 단방향
    * 테이블은 외래 키로 연관관계를 맺는다 -> 양방향
    * 객체를 양방향으로 참조하려면 단방향 연관관계 2개를 만들어야 한다

#### 순수한 객체 연관관계
#### 테이블 연관관계
#### 객체 관계 매핑
#### @JoinColumn
* name
* referencedColumnName
* foreignKey(DDL)
* 기타 @Column의 속성들
    
#### @ManyToOne
* optional
    * 기본값 true
    * false로 설정하면 연관된 엔티티가 항상 있어야 한다
* fetch
    * 글로벌 페치 전략
* cascade
    * 영속성 전이 기능
* targetEntity
    거의 사용하지 않는다, 컬렉션 제네릭으로 타입 정보 알 수 있다

---

#### 연관관계 사용
#### 저장
* JPA에서 엔티티를 저장할 때 연관된 모든 엔티티는 `영속 상태`여야 한다

#### 조회
* 객체 그래프 탐색(객체 연관관계를 사용한 조회)
* 객체지향 쿼리 사용(JPQL 등)
    
#### 수정

#### 연관관계 제거

#### 연관된 엔티티 삭제

---

### 양방향 연관관계

#### 양방향 연관관계 매핑

#### 일대다 컬렉션 조회

---

### 연관관계의 주인

* 테이블은 외래 키 하나로 두 테이블의 연관관계 관리
* 엔티티를 양방향 연관관계로 설정하면 객체의 참조는 둘인데 외래 키는 하나다
    * 그래서 주인을 정해 외래 키를 관리
    
#### 양방향 매핑의 규칙: 연관관계의 주인
* 주인만이 외래 키를 관리(등록, 수정, 삭제)할 수 있다
* 주인이 아닌 쪽은 읽기만 할 수 있다
* **주인은 mappedBy 속성을 사용하지 않는다**
* **주인이 아니면 mappedBy 속성을 사용해서 속성의 값으로 주인을 지정한다**
* 주인 = 외래 키의 관리자

#### 연관관계의 주인은 외래 키가 있는 곳


---

### 양방향 연관관계 저장

---

### 양방향 연관관계의 주의점

#### 순수한 객체까지 고려한 양방향 연관관계
* 객체 관점에서 양쪽 방향에 모두 값을 입력해주는 것이 가장 안전하다

#### ⭐연관관계 편의 메소드⭐

> **양방향 연관관계 리팩토링 습관화**

> **관계 변경 시에 기존 관계를 제거하는 로직을 잊지 말자**

---

### 정리

* 단방향 매핑만으로 테이블과 객체의 연관관계 매핑은 이미 완료되었다
* 단방향을 양방향으로 만들면 반대방향으로 객체 그래프 탐색 기능이 추가된다
* 양방향 연관관계를 매핑하려면 객체에서 양쪽 방향을 모두 관리해야 한다
* 단방향으로 사용하고, 반대 방향으로 객체 그래프 탐색 기능이 필요 할 때 양방향을 사용해도 된다

> 연관관계의 주인은 외래 키의 위치와 관련해서 의사결정, not 비즈니스의 중요도!

> 양방향 매핑 시 무한루프 조심, 특히 Json, Lombok 등
